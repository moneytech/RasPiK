#include "../include/graphics.h"

unsigned char fonts[] =
{
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x08,0x08,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x14,0x14,0x14,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x48,0x48,0x68,0xFE,0x24,0x24,0x7F,0x14,0x12,0x12,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x10,0x7C,0x92,0x12,0x1C,0x70,0x90,0x92,0x7C,0x10,0x10,0x00,0x00,
    0x00,0x00,0x00,0x06,0x09,0x09,0x46,0x38,0x66,0x90,0x90,0x60,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x38,0x04,0x04,0x0C,0x92,0xB2,0xA2,0x46,0xBC,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x30,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x10,0x20,0x00,0x00,0x00,
    0x00,0x0C,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x08,0x0C,0x00,0x00,0x00,
    0x00,0x00,0x00,0x10,0x92,0x7C,0x38,0xD6,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x7F,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x08,0x04,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x40,0x20,0x20,0x10,0x10,0x18,0x08,0x08,0x04,0x04,0x02,0x00,0x00,
    0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x92,0x82,0x82,0x44,0x38,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x1C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7C,0xC2,0x80,0x80,0x40,0x30,0x18,0x04,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7C,0x82,0x80,0xC0,0x38,0xC0,0x80,0xC2,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x60,0x50,0x58,0x48,0x44,0x42,0xFE,0x40,0x40,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7E,0x02,0x02,0x3E,0xC0,0x80,0x80,0xC2,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x78,0x84,0x02,0x7A,0xC6,0x82,0x82,0xC4,0x78,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFE,0x40,0x40,0x20,0x20,0x10,0x18,0x08,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7C,0x82,0x82,0x82,0x7C,0x82,0x82,0x86,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x3C,0x46,0x82,0x82,0xC6,0xBC,0x80,0x42,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x08,0x04,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x80,0x70,0x0E,0x0E,0x70,0x80,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x02,0x1C,0xE0,0xE0,0x1C,0x02,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x1C,0x22,0x20,0x10,0x08,0x08,0x00,0x08,0x08,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x78,0xCC,0x84,0xE2,0x92,0x92,0x92,0xE2,0x04,0x0C,0x78,0x00,0x00,
    0x00,0x00,0x00,0x10,0x28,0x28,0x28,0x44,0x44,0x7C,0xC6,0x82,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7E,0x82,0x82,0x82,0x7E,0x82,0x82,0x82,0x7E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x78,0x84,0x02,0x02,0x02,0x02,0x02,0x84,0x78,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x3E,0x42,0x82,0x82,0x82,0x82,0x82,0x42,0x3E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0xFE,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0xFE,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x78,0x84,0x02,0x02,0xC2,0x82,0x82,0x84,0x78,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x82,0x82,0x82,0x82,0xFE,0x82,0x82,0x82,0x82,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x38,0x20,0x20,0x20,0x20,0x20,0x20,0x22,0x1C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x42,0x22,0x12,0x0A,0x0E,0x12,0x22,0x22,0x42,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xC6,0xC6,0xAA,0xAA,0xAA,0x92,0x82,0x82,0x82,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x86,0x86,0x8A,0x8A,0x92,0xA2,0xA2,0xC2,0xC2,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0x44,0x38,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7E,0xC2,0x82,0x82,0xC2,0x7E,0x02,0x02,0x02,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0x44,0x78,0x60,0x40,0x00,0x00,
    0x00,0x00,0x00,0x7E,0xC2,0x82,0x82,0x7E,0x42,0x82,0x82,0x02,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7C,0x86,0x02,0x06,0x7C,0xC0,0x80,0xC2,0x7D,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x7F,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x82,0xC6,0x44,0x44,0x44,0x28,0x28,0x28,0x10,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x81,0x81,0x81,0x5A,0x5A,0x5A,0x66,0x66,0x66,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xC6,0x44,0x28,0x38,0x10,0x28,0x6C,0x44,0x82,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x41,0x22,0x14,0x14,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFE,0xC0,0x60,0x20,0x10,0x08,0x0C,0x06,0xFE,0x00,0x00,0x00,0x00,
    0x00,0x38,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x38,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x04,0x04,0x08,0x08,0x18,0x10,0x10,0x20,0x20,0x40,0x00,0x00,
    0x00,0x1C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x1C,0x00,0x00,0x00,
    0x00,0x00,0x00,0x08,0x14,0x22,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,
    0x00,0x00,0x08,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x38,0x44,0x40,0x7C,0x42,0x62,0x5C,0x00,0x00,0x00,0x00,
    0x00,0x02,0x02,0x02,0x02,0x3E,0x66,0x42,0x42,0x42,0x66,0x3E,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x38,0x44,0x02,0x02,0x02,0x44,0x38,0x00,0x00,0x00,0x00,
    0x00,0x40,0x40,0x40,0x40,0x7C,0x66,0x42,0x42,0x42,0x66,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0x42,0x7E,0x02,0x46,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x30,0x08,0x08,0x08,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0x66,0x42,0x42,0x42,0x66,0x5C,0x40,0x44,0x38,0x00,
    0x00,0x02,0x02,0x02,0x02,0x3A,0x46,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,
    0x00,0x08,0x00,0x00,0x00,0x0E,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,0x00,0x00,
    0x00,0x10,0x00,0x00,0x00,0x1C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x0E,0x00,
    0x00,0x02,0x02,0x02,0x02,0x22,0x12,0x0A,0x0E,0x12,0x22,0x42,0x00,0x00,0x00,0x00,
    0x00,0x0E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x70,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xFE,0x92,0x92,0x92,0x92,0x92,0x92,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3A,0x46,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0x42,0x42,0x42,0x66,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3E,0x66,0x42,0x42,0x42,0x66,0x3E,0x02,0x02,0x02,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0x66,0x42,0x42,0x42,0x66,0x5C,0x40,0x40,0x40,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3C,0x4C,0x04,0x04,0x04,0x04,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x02,0x3C,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x08,0x08,0x7E,0x08,0x08,0x08,0x08,0x08,0x70,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x62,0x5C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x42,0x66,0x24,0x24,0x3C,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x81,0x81,0x5A,0x5A,0x5A,0x24,0x24,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x66,0x24,0x18,0x18,0x18,0x24,0x66,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x42,0x44,0x24,0x24,0x28,0x18,0x10,0x10,0x08,0x0C,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7E,0x40,0x20,0x18,0x04,0x02,0x7E,0x00,0x00,0x00,0x00,
    0x00,0x38,0x08,0x08,0x08,0x08,0x06,0x08,0x08,0x08,0x08,0x08,0x30,0x00,0x00,0x00,
    0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,
    0x00,0x0E,0x08,0x08,0x08,0x08,0x30,0x08,0x08,0x08,0x08,0x08,0x06,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9C,0x62,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

void send_to_mailbox(uint8_t chan, uint32_t data)
{
    while (read_mmio(MAILBOX_ADDR + MAILBOX_STATE) & MAILBOX_FULL) {}
    sync_mem();
    write_mmio((MAILBOX_ADDR + MAILBOX_WRITE), chan | (data & DATAMASK32));
    sync_mem();
}

uint32_t verify_mailbox(uint8_t chan)
{
    uint32_t timeout = 0;
    uint32_t data = 0;

    while (1)
    {
        while (read_mmio(MAILBOX_ADDR + MAILBOX_STATE) & MAILBOX_EMPTY)
            if (timeout++ >= MAILBOX_TIMEOUT)
                return ERROR32;

        sync_mem();
        data = read_mmio(MAILBOX_ADDR);
        sync_mem();

        if ((data & 0xF) == chan)
            break;
    }

    return (data & DATAMASK32);
}

static int init_framebuffer(void)
{
    uint32_t mailbox_request = FRAME_BUFFER + ARM_BUS_ADDR;
    uint32_t res;

    send_to_mailbox(1, mailbox_request);

    do
    {
        res = verify_mailbox(1);
    } while (res != 0);

    if (!fb->ptr || !fb->pitch)
        return 0;

    fb->ptr = fb->ptr > ARM_BUS_ADDR ? fb->ptr - ARM_BUS_ADDR : fb->ptr;

    return 1;
}

int init_graphics(void)
{
    fb = (s_fb *)FRAME_BUFFER;
    fb->width = SCREEN_WIDTH;
    fb->height = SCREEN_HEIGHT;
    fb->v_width = fb->width;
    fb->v_height = fb->height;
    fb->pitch = 0;
    fb->depth = SCREEN_DEPTH;
    fb->x_off = 0;
    fb->y_off = 0;
    fb->ptr = 0;
    fb->size = 0;

    return init_framebuffer();
}

s_color hex_to_rgb(uint32_t color)
{
    s_color ret;
    ret.r = (color & 0xFF0000) >> 16;
    ret.g = (color & 0x00FF00) >> 8;
    ret.b = (color & 0x0000FF);
    return ret;
}

void putpixel(uint32_t x, uint32_t y, uint32_t color)
{
    s_color rgb = hex_to_rgb(color);
    uint32_t offset = (y * fb->pitch) + (x * 3);
    *(uint8_t *)(fb->ptr + offset + 0) = rgb.r;
    *(uint8_t *)(fb->ptr + offset + 1) = rgb.g;
    *(uint8_t *)(fb->ptr + offset + 2) = rgb.b;
}
